=========
CHANGELOG
=========

1.7.0 (unreleased)
------------------

- N√©cessite Debian 11 ou 12.
- Compatible avec GeoNature 2.15.0 (ou plus) et TaxHub 2.0.0 (ou plus). Fonctionne aussi avec les versions pr√©c√©dentes de GeoNature et TaxHub mais sans filtrer les √©ventuels m√©dias supprim√©s.

üöÄ **Nouveaut√©s**

- Ajout du support de Debian 12. Suppression du support de Debian 9 et 10 (#582 par @juggler31, @marcantoinedupre, @submarcos)
- Ajout de tests automatis√©s pour tester l'installation des d√©pendances Python (#582 par @juggler31)
- Nettoyage et simplification des scripts d'installation
- Suppression du support des installations sans TaxHub (#582 par @amandine-sahl)
- Suppression des installations sans ``ref_geo`` (par @TheoLechemia)
- Refonte de l'int√©gration d'outils de suivi de fr√©quentation (Google analytics, Matomo ou autre) en lien avec la mise en conformit√© RGPD (#527 @juggler31, #499 par @andriacap)
- Ajout de la librairie Orejime pour recueillir le consentement de l'utilisateur sur l'utilisation des cookies (#527 @juggler31)
- Ajout de la possibilit√© d'ajouter un lien dans le pied de page (footer) vers une modale pr√©cisant la politique des donn√©es personnelles, activable ou non avec le param√®tre ``AFFICHAGE_RGPD`` (#527 par @juggler31)
- Ajout du support des cd_nom n√©gatifs sur les fiches esp√®ces et les API (#616 par @andriacap)
- Ajout des param√®tres ``AFFICHAGE_GRAPH_PHENOLOGIE`` et ``AFFICHAGE_GRAPH_ALTITUDES`` pour afficher/masquer les graphiques de ph√©nologie et d'altitude sur les fiches esp√®ces (#568 par @gildeluermoz)
- Affichage des dates au format "court" et selon la langue du navigateur (#512 et #631 par @geobrun et @xavyeah39)
- Possibilit√© de personnaliser les attributs TaxHub du bloc "Informations esp√®ce" sur les fiches esp√®ces (#412 par @jpm-cbna) - rajouter ole param√®tre `taxhub_displayed_attr` dans le settings.ini si vous r√©installer la BDD
- Ajout de la possibilit√© d'ajouter un lien externe et d'utiliser un picto sous forme d'image dans la barre de navigation lat√©rale (#520 par @geobrun)
- Compactage des informations dans les blocs de bas de page sur les fiches esp√®ce (#601 par @bruhnild)
- Am√©lioration du responsive design (#609 par @bruhnild)
- Am√©lioration de la recherche par esp√®ces, insensible aux accents et mieux format√©e (#532 par @jpm-cbna)
- Suppression de l'affichage des balises ``<i></i>`` dans les zones de recherche de taxon (#405 par @jpm-cbna)
- Am√©lioration de la recherche par commune : mots tronqu√©s, sans accent (#531 par @jpm-cbna)
- Prise en charge du formatage markdown des contenus des attributs de description des esp√®ces provenant de TaxHub (#413 par @jpm-cbna)
- Am√©lioration des performances des requ√™tes des fiches esp√®ces en for√ßant l'utilisation des index de la BDD (#516 par @jpm-cbna)
- Am√©lioration du chargement des mailles des observations sur les fiches esp√®ces en optimisant ``atlas.vm_observations_mailles`` (#518 par @jpm-cbna et @juggler31)
- Mise √† jour des d√©pendances Python (Flask version 2 √† 3, marshmallow 3 √† 4...)
- Possibilit√© de d√©finir l'option ``fetch_size`` des connexions de BDD en Foreign data wrapper (#657 par @jpm-cbna)

üêõ **Corrections**

- Correction de l'affichage des observations par maille sur la carte des fiches "Commune" (#453 par @jpm-cbna)
- Correction de l'affichage par maille sur les cartes des fiches "Commune" (#533 par @jpm-cbna)
- Correction et am√©lioration de l'affichage de la fen√™tre listant les sous-taxons agr√©g√©s sur les fiches esp√®ces (#558 par @jpm-cbna)
- Prise en charge des cd_nom n√©gatifs (#616 par @andriacap)
- Correction du lien vers le statut INPN des taxons prot√©g√©s sur la page organisme (#578 par @marcantoinedupre)
- Correcion du "lazy-loading" des images sur les page HTML (#590 par @submarcos)
- Suppression de la possibilit√© de masquer l'URL de TaxHub quand on r√©cup√®re un m√©dia et du param√®tre associ√© ``REMOTE_MEDIAS_PATH`` (#642 par @TheoLechemia)
- Suppression d'erreurs javascript sur la page d'accueil (#403 par @jpm-cbna)
- Prise en charge compl√®te du param√®tre ``SPLIT_NOM_VERN`` (#514 par @xavyeah39)

üë®‚Äçüíª **D√©veloppement**

- Ajout d'un Makefile afin de faciliter les d√©veloppements (#576 par @juggler31)
- Ajout de la possibilit√© de cr√©er des images Docker sur un fork du d√©p√¥t (#585 par @submarcos)
- Correction du fichier ``.gitignore`` (#554 par @sfermigier)

‚ö†Ô∏è **Notes de version**

- Il est d√©sormais possible d'installer ou mettre √† jour GeoNature uniquement sur Debian 11 et 12.
- Suppression de la possibilit√© d'installer GeoNature-atlas √† partir de couches shapefile. Tous les zonages et les mailles sont bas√©s sur le ``ref_geo`` fourni par GeoNature ou TaxHub. Il est maintenant obligatoire de disposer de TaxHub (dans GeoNature ou √† part) pour d√©ployer GeoNature-atlas. Alimenter GeoNature-atlas avec GeoNature reste optionnel.
- Veuillez vous r√©f√©rer √† la documentation concernant le RGPD et le consentement du recueil de cookies : https://github.com/PnX-SI/GeoNature-atlas/blob/master/docs/cookies_rgpd.rst. Ces fonctionnalit√©s sont utiles uniquement si vous avez mis en place le recueil de cookies n√©cessitant le consentement de l'utilisateur (statistiques de fr√©quentation avec Google Analytics par exemple). 
- Le param√®tre ``ID_GOOGLE_ANALYTICS`` et l'int√©gration native d'un script Google analytics sont d√©pr√©ci√©s. Se r√©f√©rer √† la documentation sur le RGPD ci-dessus si vous suivez la fr√©quentation de votre GeoNature-atlas avec Google Analytics.
- Le param√®tre ``REMOTE_MEDIAS_PATH`` est depreci√©, seul ``REMOTE_MEDIAS_URL`` permet de construire l'URL des m√©dias "locaux" (dont le champs ``chemin`` est rempli).
- Pour ajouter un lien vers la politique de gestion des donn√©es personnelles dans le pied de page (footer), r√©percuter les `√©volutions <https://github.com/PnX-SI/GeoNature-atlas/pull/574/files#diff-05964f85b0bb6f2d285f98fe1e3a56d9343b8a740ddd8c7e6ac85cfd611f62bb>`_ du template de footer dans votre fichier ``custom/templates/footer.html``, copier le fichier `custom/templates/personal-data.html.sample <https://github.com/PnX-SI/GeoNature-atlas/blob/develop/atlas/static/custom/templates/personal-data.html.sample>`_ en ``custom/templates/personal-data.html`` (``cp custom/templates/personal-data.html.sample custom/templates/personal-data.html``), puis adapter le contenu du fichier ``custom/templates/personal-data.html`` √† votre contexte 

Si vous mettez √† jour GeoNature-atlas, suivez la proc√©dure classique de MAJ d√©crite dans : https://github.com/PnX-SI/GeoNature-atlas/blob/master/docs/installation.rst#mise-%C3%A0-jour-de-lapplication

- Ajoutez l'extension ``unaccent`` √† la base de donn√©es ``CREATE EXTENSION IF NOT EXISTS unaccent SCHEMA "public";`` (#531, #532)
- Ex√©cutez le script SQL de mise √† jour de la BDD : https://github.com/PnX-SI/GeoNature-atlas/blob/master/data/update/update_1.6.1to1.7.0.sql (Attention √† remplacer l'utilisateur ``geonatatlas`` dans les GRANT √† la fin du fichier si vous avez chang√© l'utilisateur lecteur ``user_pg`` dans le fichier ``settings.ini``)

Vous pouvez supprimer les param√®tres suivants du fichier ``settings.ini`` :

- ``use_ref_geo_gn2``
- ``install_taxonomie``
- ``communes_shp``
- ``colonne_insee``
- ``colonne_nom_commune``
- ``limit_shp``
- ``metropole``
- ``taillemaille``
- ``chemin_custom_maille``
- ``taxhub_release``

1.6.1 (2023-10-16)
------------------

üöÄ **Nouveaut√©s**

- Possibilit√© de surcoucher les fichiers du dossier ``static`` en les pla√ßant avec le m√™me nom dans le dossier ``custom`` (#496)

  - Par exemple pour surcoucher le pictogrammes des mammif√®res, mettre le votre dans ``custom/images/picto_Mammiferes.png``
- Possibilit√© de customiser le fichier ``navbar.html`` (d√©plac√© dans le dossier ``static/custom/templates``) (#496)
- Ajout d'un linter pour le code python (``black``)

‚ö†Ô∏è **Notes de version**

- Si l'application n'est pas √† la racine du serveur (par exemple avec ``/atlas``), la configuration Apache est √† modifier et devient :
  ::
    <Location /atlas>
        ProxyPass  http://127.0.0.1:8080/atlas
        ProxyPassReverse  http://127.0.0.1:8080/atlas
    </Location>

- Copier le fichier ``navbar.html`` dans le dossier ``atlas/static/custom/templates/`` :
  ::
    cp atlas/static/custom/templates/navbar.html.sample atlas/static/custom/templates/navbar.html


1.6.0 (2023-09-15)
------------------

üöÄ **Nouveaut√©s**

- Ajout du param√®tre ``DISPLAY_OBSERVERS`` permettant de masquer les observateurs des fiches esp√®ces (#439 par @mvergez)
- [Docker] Ajout d'un fichier ``Dockerfile`` permettant de dockeriser GeoNature-atlas (#470)
- [Docker] Ajout d'une Github action publiant automatiquement les images Docker de GeoNature-atlas
- [Docker] Ajout des scripts ``docker_startup.sh`` et ``docker_install_atlas_schema.sh`` (sera ex√©cut√© au d√©marrage du container si la variable d'environnement ``ATLAS_INSTALL_SCHEMA`` est √†  ``true``) (#470)
- Possibilit√© de d√©finir le chemin vers le fichier de config avec ``ATLAS_SETTINGS`` (par d√©faut ``atlas/configuration/config.py``) (#470)
- Possibilit√© de d√©finir le chemin vers le dossier des templates avec ``ATLAS_TEMPLATE_FOLDER`` (par d√©faut ``.``) (#470)
- Possibilit√© de d√©finir le chemin vers le dossier des templates avec ``ATLAS_STATIC_FOLDER`` (par d√©faut ``atlas/static``) (#470)
- Gestion du proxy avec ``ProxyFix`` (#470)
- Mise √† jour de Flask en version 2 et de nombreuses d√©pendances Python (#470)

üêõ **Corrections**

- Corrections linguistiques (#383 par @Splendens)
- Correction d'une traduction (#433 par @mvergez)
- Harmonisation et correction des fiches organismes (#382, #384 par @Splendens)
- Correction de l'affichage des pictos des groupes 2 INPN quand leur nom contient un accent (#380 par @Splendens)
- Am√©lioration de l'affichage des logos des organismes sur la page d'accueil (#381 par @Splendens)
- Affichage de lb_nom en italique (#387 par @Splendens)
- Affichage HTML du titre du m√©dia principal dans les fiches esp√®ce (#420 par @joelclems)
- Correction du scroll infini de la galerie photo (#430 par @mvergez)
- Correction des liens vers les fiches esp√®ces dans la galerie photo
- Correction du lien vers les fiches esp√®ces dans la galerie photo (#459 par @jpm-cbna)
- Correction du bouton de tri (al√©atoire ou nombre d'observation) dans la galerie photo
- Am√©lioration du lien vers la fiche d'un taxon depuis la galerie photo (#432 par @mvergez)
- Correction de l'affichage de la liste des taxons sur les fiches communes (#445 par @mvergez)
- Prise en compte des cas o√π le SRID est diff√©rent de 2154 lors de la cr√©ation de ``atlas.vm_mailles_territoire`` (#417 par @joelclems)
- Harmonisation de l'affichage du picto group2_inpn (#424, #425, #426, #427, #429 par @MissT)
- Affichage en double de la l√©gende quand le slider √©tait manipul√© (#452 par @mvergez)
- Exclusion des m√©dias supprim√©s dans la vue ``vm_medias`` (#458 par @jpm-cbna)
- Sp√©cification du port de base de donn√©es dans le script ``install_db.sh`` (#422 par @geobrun)
- Correction des photos lors du scroll dans les fiches des communes (#448 par @mvergez)
- Affichage cartographique sur la page "Recherche avanc√©e" (#486)
- Support des cd_ref n√©gatifs

üêõ **Optimisations**

- Optimisation de la requ√™te de s√©lection des "Nouvelles esp√®ces observ√©es" (#455 par @andriacap)
- Mise en cache des statistiques de la page d'accueil (#400 par @TheoLechemia)
- Optimisation et ajout d'index sur la vue ``atlas.vm_cor_taxon_organism`` (#463 par @jpm-cbna)
- Redirection des URL des fiches esp√®ces des synonymes vers les noms de r√©f√©rence (#388 par @jpm-cbna)
- Suppression des requ√™tes inutiles sur la page d'accueil (#275 par @jpm-cbna)
- Nettoyage et optimisation du code (#395, #407, #396, #394 par @jpm-cbna)
- Ajout du param√®tre permettant de recharger automatiquement les templates (#431 par @mvergez)

‚ö†Ô∏è **Notes de version**

Si vous mettez √† jour GeoNature-atlas :

- Ex√©cutez le script SQL de mise √† jour de la BDD : https://github.com/PnX-SI/GeoNature-atlas/blob/master/data/update/update_1.5.2to1.6.0.sql
- Dans le fichier de configuration ``config.py``, changez le nom du param√®tre ``database_connection`` en ``SQLALCHEMY_DATABASE_URI``
- Si vous utilisiez le param√®tre ``ANONYMIZE``, celui-ci est √† remplacer par ``ORGANISM_MODULE`` et ``DISPLAY_OBSERVERS`` qui permettent d'afficher ou non ind√©pendamment les organismes et les observateurs
- Suivez la proc√©dure classique de mise √† jour de l'application

1.5.1 (2021-12-06)
------------------

üêõ **Corrections**

- Ajout de l'utilisation de ``nvm`` dans le script ``install_app.sh`` (par @gildeluermoz)
- Nettoyage de la documentation (par @gildeluermoz)
- Mise √† jour de la version du sch√©ma ``taxonomie`` pour une installation sans GeoNature (par @gildeluermoz)

‚ö†Ô∏è **Notes de version**

Si vous mettez √† jour GeoNature-atlas :

- Vous pouvez passer directement √† cette version, mais en suivant les notes de versions interm√©diaires
- T√©l√©charger et installer ``nvm`` :

::

    wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash

    export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm
- Suivez la proc√©dure classique de mise √† jour de l'application.

1.5.0 (2021-12-02)
------------------

üöÄ **Nouveaut√©s**

**1. Affichage des organismes (#291 par @corentinlange)**

- Affichage des organismes activable avec le param√®tre ``ORGANISM_MODULE`` (d√©sactiv√© par d√©faut) (#325)
- Affichage des organismes ayant fourni des donn√©es d'une esp√®ce dans la fiche esp√®ce (#315)
- Int√©gration du bandeau organisme sur la page d'accueil (#245 par @Splendens)
- Cr√©ation de fiches organismes, avec logo, nom, nombre de donn√©es, esp√®ces les plus observ√©es et familles de taxons observ√©s par un organisme (#291)

**2. Multilingue (#175 par @TheMagicia et @corentinlange)**

- Mise en place du multilingue (activable avec le param√®tre ``MULTILINGUAL``) avec les fichiers de langue de traduction de l'interface en fran√ßais, anglais et italien
- Langue d√©tect√©e automatiquement en fonction de la langue du navigateur
- Possibilit√© pour l'utilisateur de basculer sur une autre langue disponible
- Optimisation du multilingue pour le r√©f√©rencement par les moteurs de recherche
- Redirection automatique des URL sans cl√© de langue pour le r√©f√©rencement et les anciennes URL
- Documentation (``docs/multilingual.rst``)

**3. Bootstrap 4 (#233 par @lpofredc)**

- Mise √† jour de Bootstrap version 3 √† 4 (#230)
- Remplacement de la police d'ic√¥nes Glyphicon par Font Awesome
- Correction de l'absence de la hi√©rarchie sur les fiches taxons
- Restructuration des templates (avec ``includes`` & ``blocks``) et mutualisation des parties partag√©es
- Refonte de la page commune, notamment en fixant la carte et en ne scrollant que dans la liste (#79)
- Remplacement de la librairie des graphiques morris/D3 par chart.js (#164)
- Ajout d'un fichier ``sitemap.xml`` √† la racine de l'application, autog√©n√©r√© pour optimiser le r√©f√©rencement par les moteurs de recherche (#44)
- Ajout d'un fichier ``robots.txt`` √† la racine de l'application, √† partir d'un template customisable, pour indiquer aux moteurs de recherche les pages qu'ils peuvent indexer ou non (#223)
- Utilisation des zonages activ√©s uniquement dans le ``ref_geo`` (``enable = true``)
- Possibilit√© de customiser en CSS la couleur des contours des objets sur les cartes (mailles, territoire, zonages)
- Corrections de la hi√©rarchie taxonomique
- Possibilit√© de masquer les observateurs avec le nouveau param√®tre ``ANONYMIZE``
- Possibilit√© que les liens dans le menu lat√©ral soient des liens externes (en remplacant la cl√© ``template`` par la cl√© ``url`` au niveau du param√®tre ``STATIC_PAGES``)

**4. Nouvelles esp√®ces**

- Ajout d'un bloc "Nouvelles esp√®ces observ√©es" sur la page d'accueil, permettant d'afficher les derni√®res esp√®ces d√©couvertes (premi√®re observation d'une esp√®ce) sur le territoire (#85 par @MathildeLeclerc)

**5. Autres**

- Possibilit√© d'afficher l'echelle sur la carte avec le param√®tre ``ENABLE_SCALE`` (#293 par @mvergez)
- Possibilit√© d'ajouter un masque sur la carte en dehors du territoire avec le param√®tre ``MASK_STYLE`` (#89 par @mvergez)
- Ajout de pictos manquants (#272 par @jpm-cbna)

**6. D√©veloppement**

- Support de Debian 11
- Installation d√©coup√©e (#332 et #349 par @corentinlange)
- Mise en place de npm pour installer les d√©pendances (#310 par @corentinlange)
- Mise en place de la structure de tests Backend (avec Pytest) et Frontend (avec Jest) (#297 et #316)
- Remplacement de ``supervisor`` par ``systemd``
- Ajout d'un param√®tre de d√©finition du timeout de gunicorn (#271 par @jpm-cbna)
- Mise √† jour des d√©pendances
- R√©organisation du code et packaging
- Ajout d'une page de recherche avanc√©e, permettant d'afficher les observations par maille de 3 esp√®ces en m√™me temps, √† tester et finaliser (#313 par @lpofredc)
- Ajout de la possibilit√© de proposer d'autres types de zonages que les communes, √† tester, g√©n√©riciser et finaliser (#209 par @lpofredc)

üêõ **Corrections**

- Retrait des ``-n`` dans le fichier d'installation (#306 par @corentinlange)
- Correction de l'API ``searchCommune`` en fermant les sessions DB (#277 par @jpm-cbna)

‚ö†Ô∏è **Notes de version**

Si vous mettez √† jour GeoNature-atlas :

- Stopper le service ``atlas`` de supervisor (``sudo supervisorctl stop atlas``). Supprimez √©galement le fichier de configuration supervisor de l'atlas (``sudo supervisorctl remove atlas && sudo rm /etc/supervisor/conf.d/atlas-service.conf && sudo supervisorctl reread``)
- Ajouter la variable ``SECRET_KEY`` au fichier ``config.py`` (utilis√©e pour chiffrer la session), et remplissez-la avec une chaine de texte al√©atoire.
- Relancer l'installation compl√®te de la BDD car de nombreux √©l√©ments ont √©volu√©, en lancant le script ``install_db.sh``, apr√®s avoir pass√© le param√®tre ``drop_apps_db`` √† ``true`` dans le fichier ``settings.ini``. Cela va compl√®tement supprimer et recr√©er votre BDD de GeoNature-atlas. Si vous aviez modifi√© la vue ``synthese.syntheseff`` ou des vues mat√©rialis√©es, vous devrez reporter ces modifications apr√®s la r√©installation de la BDD de GeoNature-atlas.

  Si votre GeoNature-atlas est connect√© √† une BDD GeoNature distante, vous devez au pr√©alable √©tendre les droits de lecture de l'utilisateur PostgreSQL utilis√© pour lire les donn√©es au niveau de cette BDD GeoNature source (https://github.com/PnX-SI/GeoNature-atlas/blob/master/atlas/configuration/settings.ini.sample#L65) :

  ::

      GRANT USAGE ON SCHEMA utilisateurs, gn_meta TO geonatatlas;
      GRANT SELECT ON ALL TABLES IN SCHEMA utilisateurs, gn_meta TO geonatatlas;

- Suivez la proc√©dure classique de mise √† jour de l'application.
- Le nom du service systemd est d√©sormais ``geonature-atlas``
- Les logs sont d√©sormais dans ``/var/log/geonature-atlas.log``. Vous pouvez supprimer le r√©pertoire ``log`` √† la racine de l'atlas qui est obsol√®te.

1.4.2 (2020-11-25)
------------------

**üêõ Corrections**

* D√©sactivation de la route des observations ponctuelles quand l'atlas est param√©tre en mode mailles (#237 par @lpofredc)
* Correction de l'affichage des rangs taxonomiques sur les fiches esp√®ces
* Ajout d'index sur les vues mat√©rialis√©es ``atlas.t_layer_territoire`` et ``atlas.vm_mailles_territoire`` pour pouvoir les rafraichir en parall√®le (#254 et #260)
* Correction des observations dupliqu√©es dans les fiches communes (#225 par @jpm-cbna)
* Correction des liens vers les fiches esp√®ce depuis la carte de la page d'accueil en mode mailles (#221 par @jpm-cbna et @lpofredc)
* Correction du spinner pour la recherche par commune (#227 par @jpm-cbna)
* Corrections CSS supprimant un scroll horizontal global (par @jpm-cbna) et un probl√®me de positionnement sur la page de pr√©sentation
* Mise √† jour de la d√©pendance Python ``SQLAlchemy`` en version 1.3.19
* Clarification de la documentation et du fichier d'exemple de ``settings.ini``

**‚ö†Ô∏è Notes de version**

* Si vous mettez √† jour l'application, ex√©cutez le script SQL de mise √† jour de la BDD : https://github.com/PnX-SI/GeoNature-atlas/blob/master/data/update_1.4.1to1.4.2.sql
* Si vous disposiez d'un GeoNature de version inf√©rieure √† 2.5 et que vous passez √† cette version, adaptez la table √©trang√®re : ``ALTER FOREIGN TABLE synthese.synthese DROP id_nomenclature_obs_meth;``
* Suivez la proc√©dure classique de mise √† jour : https://github.com/PnX-SI/GeoNature-atlas/blob/master/docs/installation.rst#mise-%C3%A0-jour-de-lapplication

1.4.1 (2019-10-09)
------------------

**üêõ Corrections**

* Correction de syntaxe dans le fichier exemple de la configuration ``config.py.example`` (#206 et #208)
* Correction du responsive sur la page d'accueil
* Correction du slider d'ann√©e sur les fiches esp√®ce en mode maille
* Correction d'un import python incorrect (#205)
* Corrections mineures et mise en forme de la documentation
* Requete ``get_taxon`` : utilisation ``get_or_none`` au lieu de prendre l'index 0 de la liste (#207)
* Correction de la serialisation de la route des observations ponctuelles (doit contenir la cl√© ``year`` pour que le slider fonctionne)

**‚ö†Ô∏è Notes de version**

* Si vous effectuez une mont√©e de version, la correction du responsive n√©cessite une correction sur le fichier du customisation ``introduction.html``. Supprimer simplement la premi√®re balise ``<div class="col-sm-12">`` et sa balise fermante correspondante (√† la derni√®re ligne du fichier).
* Suivez la proc√©dure classique de mise √† jour : https://github.com/PnX-SI/GeoNature-atlas/blob/master/docs/installation.rst#mise-%C3%A0-jour-de-lapplication

1.4.0 (2019-10-01)
------------------

**üöÄ Nouveaut√©s**

* Compatible avec GeoNature version 2 et connexion possible au r√©ferentiel g√©ographique (#162)
* Fiches esp√®ce : les mailles ne sont plus dupliqu√©es pour am√©liorer les performances (#53)
* Passage √† Python 3 (par @aroche)
* Prise en compte de la d√©gradation des donn√©es (centro√Øde de la g√©om√©trie d√©grad√©e) de GeoNature, bas√© sur les niveaux de diffusion du SINP (voir http://standards-sinp.mnhn.fr/nomenclature/5-niveaux-de-precision-de-diffusion-souhaites-niveauprecision-23-06-2016/)
* Am√©lioration du module de recherche de taxons (AJAX + trigrammes) (par @aroche)
* Am√©lioration du module de recherche de commune (AJAX) (par @aroche)
* Chargement "paresseux" des images dans les listes de taxons et la page d'accueil (par @aroche)
* Mise en place de param√®tres par d√©faut, surcouchables si besoin. V√©rification des param√®tres de configuration gr√¢ce √† Marshmallow et passage de param√®tres par d√©faut si param√®tres absents
* Simplification du passage de la configuration aux routes
* Ajout de la description, de la licence et de la source sur les m√©dias (par @sig-pnrnm)
* Formatage des grands nombres (par @jbdesbas)
* Ordonnancement des noms de communes par longueur (#193) (par @jbdesbas)
* Standardisation GeoJson des API
* Ajout de fonctions SQL pour rafraichir uniquement les vues mat√©rialis√©es des donn√©es dans l'ordre (``atlas.refresh_materialized_view_data()``) ou uniquement les donn√©es g√©ographiques plus stables (``atlas.refresh_materialized_view_ref_geo()``)
* Possibilit√© de masquer le slider de la carte des fiches esp√®ces (``ENABLE_SLIDER``)
* Possibilit√© de limiter l'√©tendue de la carte (param√®tre ``MAX_BOUNDS``) (par @jbdesbas)
* Ajout du param√®tre ``REDIMENSIONNEMENT_IMAGE`` qui active ou non le redimmensionnement √† la vol√©e par TaxHub
* Ajout du param√®tre ``DISPLAY_PATRIMONIALITE`` qui contr√¥le l'affichage du logo "patrimonial" sur les fiches esp√®ce et les listes
* Rafraichissement du graphisme
* Facilitation de la customisation gr√¢ce √† des variables CSS
* Compl√©ments divers de la documentation (``/docs/``)

**üêõ Corrections**

* Renommage du r√©pertoire ``main`` en ``atlas``
* Suppression du param√®tre ``COLONNES_RANG_STAT`` (calcul√©)
* Suppression du param√®tre ``IGNAPIKEY`` (le passer directement dans les variables ``MAP.FIRST_MAP`` et ``MAP.SECOND_MAP``)
* Corrections diverses (par @xavyeah39 et @RomainBaghi)

**‚ö†Ô∏è Notes de version**

Si vous souhaitez connecter l'atlas √† GeoNature 2, pr√©ferez une nouvelle installation de GeoNature-atlas 1.4.0, plut√¥t qu'une migration.

Dans le cas contraire, suivez les instructions suivantes :

* Ajouter l'extension Trigramme √† PostgreSQL :

::

    sudo ls
    sudo -n -u postgres -s psql -d $db_name -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"

Lancer le script de migration update_1.3.2to1.4.0.sql (https://github.com/PnX-SI/GeoNature-atlas/blob/master/data/update_1.3.2to1.4.0.sql) avec l'utilisateur lecteur de l'application (cf settings.ini : ``user_pg``)

* Des nouvelles variables CSS permettent de customiser les couleurs de l'application. Vous pouvez ajouter les variables ci-dessous au fichier ``static/custom/custom.css`` et les adapter √† votre contexte (les variables ``--main-color`` et ``--second-color`` sont les couleurs principalement utilis√©es : bouton, scrollbar, navbar etc...)

::

    :root {
    --main-color: #82c91e;
    --second-color: #649b18;
  }

Suivez ensuite les instructions suivantes :

* T√©l√©charger puis d√©zipper la nouvelle version de l'atlas.

::

    cd /home/`whoami`
    wget https://github.com/PnX-SI/GeoNature-atlas/archive/X.Y.Z.zip
    unzip X.Y.Z
    rm X.Y.Z

* Renommer l'ancienne version de l'atlas puis la nouvelle version.

::

    mv /home/`whoami`/atlas/ /home/`whoami`/atlas_old/
    mv GeoNature-atlas-X.Y.Z /home/`whoami`/atlas/

* Copier les fichiers ``settings.ini`` et ``config.py`` depuis l'ancienne version vers la nouvelle pour r√©cup√©rer vos param√®tres de configuration :

::

    cd atlas
    cp ../atlas_old/main/configuration/settings.ini atlas/configuration/settings.ini
    cp ../atlas_old/main/configuration/config.py atlas/configuration/config.py


* Ouvrir le fichier ``settings.ini`` pour y rajouter le nouveau param√®tre suivant (laisser la valeur fournie) :

::

    python_executable=/usr/bin/python3

* Le passage √† Python 3 n√©cessite quelques √©volutions dans le fichier ``config.py`` : il faut supprimer tous les appels √† la fonction ``unicode``). Ouvrez-le, puis supprimer la ligne 20 ``STRUCTURE = unicode(STRUCTURE, 'utf-8')``, la ligne 24 ``NOM_APPLICATION = unicode(NOM_APPLICATION, 'utf-8')`` et les lignes 113-114 ``for i in range(len(RANG_STAT_FR)): RANG_STAT_FR[i]=unicode( RANG_STAT_FR[i], 'utf-8')``

* Dans le fichier ``config.py``, supprimer le param√®tre ``IGNAPIKEY`` et int√©grer votre cl√© IGN directement dans les variables ``FIRST_MAP`` et ``SECOND_MAP``.

* Si le redimmensionnement d'image √©tait activ√©, passer la variable ``REDIMENSIONNEMENT_IMAGE`` √† ``True`` dans le fichier de configuration ``config.py``

* Copier le contenu du r√©pertoire ``static/custom/`` depuis l'ancienne version vers la nouvelle pour r√©cup√©rer toute votre customisation (CSS, templates, images...) :

::

    cp -aR ../atlas_old/static/custom/ ./static

* Relancez l'installation automatique de l'application :

::

    ./install_app.sh

* Relancer l'application

::

    sudo supervisorctl restart atlas

1.3.2 (2018-05-17)
------------------

**Corrections**

* Correction erreur d'import inutilis√© dans ``initAtlas.py``

1.3.1 (2018-03-15)
------------------

**Corrections**

* Correction de l'installation autonome (sans GeoNature)
* Correction et documentation si l'atlas est accessible dans un sous-r√©pertoire du domaine
* Correction d'une coquille dans le SQL. Merci @lpofredc

1.3.0 (2018-02-15)
------------------

**Nouveaut√©s**

* Passage de WSGI √† Gunicorn pour simplifier et homog√©n√©iser les serveurs Web des diff√©rentes applications (TaxHub, GeoNature...)
* T√©l√©charger TAXREF sur geonature.fr et non plus sur le d√©p√¥t de TaxHub
* Am√©lioration du message par d√©faut sur la HOME pour les dernieres observations
* Optimisation de certaines requ√™tes
* Prise en compte du HTML dans le champs AUTEUR
* Ajout de picto pour les groupes H√©patiques et Anthoc√©rotes
* Prise en compte des groupes INPN contenant des espaces
* TaxHub 1.3.2 permet de g√©n√©rer √† la vol√©e des vignettes des images. Ces vignettes sont d√©sormais utilisables dans GeoNature-atlas pour √©viter de charger des grandes images dans les listes de taxons. Pour cela un param√®tre ``TAXHUB_URL`` a √©t√© ajout√© (#129)
* Dans les versions pr√©c√©dentes seule une page statique PRESENTATION √©tait disponible. Seul son contenu √©tait modifiable. Les pages statiques sont d√©sormais param√©trables (template, nom, picto et ordre) et il est possible d'en cr√©er autant qu'on le souhaite en les listant dans le param√®tre ``STATIC_PAGES`` (#131)
* Possibilit√© de customiser l'affichage des points et leur style en fonction des valeurs du champs voulu dans ``atlas.vm_observations``. Pour cela, il faut renseigner le fichier de surcouche javascript ``static/custom/maps-custom.js`` (#133)
* Possibilit√© de customiser l'affichage et les valeur de la colonne Patrimonialit√© dans les listes de taxons, √† l'aide du param√®tre ``PATRIMONIALITE`` dans ``main/configuration/custom.py`` (#134)

**Corrections**

* Suppression d'un double appel √† un fichier JS dans le template des fiches esp√®ces (merci @sig-pnrnm)
* Correction d'un bug du slider et de la carte Leaflet dans Chrome (#109)
* Correction des jointures pour pr√©venir les caract√®res invisibles (#121, merci @mathieubossaert)
* Correction de l'affichage des singulers et pluriels en ajoutant des conditions (merci @Splendens)
* Am√©lioration, formatage et simplification de la gestion des param√®tres dans le fichier de routes ``main/atlasRoutes.py``
* Important nettoyage du code, factorisation et style

**Notes de version**

* Suivre la proc√©dure standard de mise √† jour
* Compl√©ter le fichier de configuration (``main/configuration/config.py``) en ajoutant les nouveaux param√®tres ``TAXHUB_URL`` et ``STATIC_PAGES``, en se basant sur le fichier d'exemple ``main/configuration/config.py.sample``.
* Compl√©ter ce m√™me fichier de configuration en adaptant le param√®tre ``PATRIMONIALITE`` au nouveau fonctionnement. Pour un fonctionnement par d√©faut, vous pouvez copier le param√©trage par d√©faut (https://github.com/PnEcrins/GeoNature-atlas/blob/c27f15af3879d6f2664d0e3220dd32c52e5145df/main/configuration/config.py.sample#L165-L177)
* Pour que les modifications du fichier de configuration soient prises en compte, il faut d√©sormais lancer ``sudo supervisorctl reload``.
* Ex√©cutez le script de mise √† jour de la BDD ``data/update_1.2.6to1.3.0.sql`` apr√®s l'avoir analys√© et lu ses commentaires
* Passage de WSGI √† Gunicorn....
Compl√©ter le fichier ``main/configuration/settings.ini`` avec les parties ``Gunicorn settings`` et ``Python settings``, en se basant sur le fichier d'exemple ``main/configuration/settings.ini.sample``

::

  sudo apt-get install -y supervisor
  ./install_app.sh

Activer les modules et red√©marrer Apache

::

    sudo a2enmod proxy
    sudo a2enmod proxy_http
    sudo apache2ctl restart

Supprimer le fichier ``atlas.wsgi`` si il est pr√©sent √† la racine de l'application

Mettre √† jour la configuration Apache de votre GeoNature-atlas (``/etc/apache2/sites-available/atlas.conf``) en remplacant son contenu (modifier le port en fonction) :

::

    # Configuration Geonature-atlas
    RewriteEngine  on
    RewriteRule    "atlas$"  "atlas/"  [R]
    <Location /atlas>
        ProxyPass  http://127.0.0.1:8080/
        ProxyPassReverse  http://127.0.0.1:8080/
    </Location>
    #FIN Configuration Geonature-atlas

* Reportez les modifications du template ``static/custom/templates/introduction.html`` en r√©percutant la nouvelle m√©thode d'obtention des templates des pages statiques : https://github.com/PnEcrins/GeoNature-atlas/blob/6d8781204ac291f11305cf462fb0c9e247f3ba59/static/custom/templates/introduction.html.sample#L15

* Modifier votre template ``static/custom/templates/presentation.html`` en r√©percutant la modification du nom du fichier CSS des pages statiques : https://github.com/PnEcrins/GeoNature-atlas/blob/6d8781204ac291f11305cf462fb0c9e247f3ba59/static/custom/templates/presentation.html.sample#L20

1.2.6 (2017-06-30)
------------------

**Nouveaut√©s**

* Ajout des param√®tres ``BORDERS_COLOR`` et ``BORDERS_WEIGHT`` pour modifier la couleur et l'√©paisseur des limites du territoire.
* Passer la fonction PostgreSQL ``RefreshAllMaterializedViews`` en mode concurrent par d√©faut https://www.postgresql.org/docs/9.4/static/sql-refreshmaterializedview.html

**Corrections**

* Utiliser aussi ces param√®tres pour la l√©gende des cartes
* Correction de la l√©gende de la carte de la Home en mode point (qui affichait la l√©gende des Mailles)

**Notes de version**

* Ajoutez les param√®tres ``BORDERS_COLOR`` et ``BORDERS_WEIGHT`` dans votre fichier ``main/configuration/config.py`` comme indiqu√© dans le fichier d'exemple (https://github.com/PnEcrins/GeoNature-atlas/blob/master/main/configuration/config.py.sample)
* Si vous utilisez une version sup√©rieure √† 9.3, il est conseill√© de rafraichir les vues mat√©rialis√©es de mani√®re concurrente pour ne pas bloquer l'acc√®s √† la BDD pendant un rafraichissement. Si ce n'est pas le cas pour votre vue, il est conseill√© de la modifier (sch√©ma ``public``) comme propos√© d√©sormais : https://github.com/PnEcrins/GeoNature-atlas/blob/master/data/atlas.sql#L406-L423

1.2.5 (2017-04-07)
------------------

**Nouveaut√©s**

* Par d√©faut, ne plus limiter les observations √† celles de l'organisme 2
* Correction mineure de CSS (Bloc "A voir en ce moment" de la page d'accueil)

1.2.4 (2017-03-07)
------------------

**Nouveaut√©s**

* Compatibilit√© avec GeoNature 1.9.0 (multiprojection)
* Ajout du script SQL ``data/update_vm_observations.sql``, permettant de faciliter la mise √† jour de la vue ``atlas.vm_observations``

**Notes de version**

* Ex√©cutez le script ``data/update1.2.3to1.2.4.sql``
ATTENTION : vous ne devez ex√©cuter ce script que si vous avez mis √† jour la base de GeoNature en version 1.9.0.
Si vous utilisez l'atlas sans GeoNature, cette mise √† jour n'est pas n√©cessaire.
* Si vous souhaitez adapter la vue mat√©rialis√©e ``atlas.vm_observations`` contenant toutes les observations, vous pouvez l'adapter dans le script ``data/update_vm_observations.sql`` puis ex√©cuter celui-ci.


1.2.3 (2017-02-23)
------------------

**Nouveaut√©s**

* Am√©liorations de la documentation
* Ajout d'un champs ``diffusable`` (oui/non) dans la synthese de GeoNature, utilisable pour ne pas afficher les donn√©es sensibles dans l'atlas au moment de la cr√©ation de la VM des observations.

**Notes de version**

* Ex√©cutez le script ``data/update1.2.2to1.2.3.sql`` pour ajouter la colonne ``diffusable`` √† la table ``synthese.syntheseff``.
Si vous utilisez l'atlas sans GeoNature, cette mise √† jour n'est pas n√©cessaire.
* Supprimez puis relancez la cr√©ation de la vue ``atlas.vm_observations`` et les vues qui en d√©pendent en utilisant le script ``data/update_vm_observations.sql``.

1.2.2 (2016-12-14)
------------------

**Am√©liorations**

* Simplification des utilisateurs PostgreSQL et suppression du besoin d'un utilisateur super utilisateur.
* Correction des tooltips qui ne fonctionnaient plus sur les pages suivantes dans les listes pagin√©es
* Am√©lioration de la gestion des m√©dias et possibilit√© de cacher l'URL h√©bergeant les m√©dias.
* Correction de la cr√©ation de ``atlas.vm_altitudes``

**Notes de version**

Si vous mettez √† jour l'application, r√©alisez ces op√©rations en plus des op√©rations classiques (https://github.com/PnEcrins/GeoNature-atlas/blob/master/docs/installation.rst#mise-√†-jour-de-lapplication) :

* Ajouter un param√®tre ``modeDebug`` dans le fichier ``main/configuration/config.py`` : https://github.com/PnEcrins/GeoNature-atlas/blob/b055c834d0f5a030f5180fa46097931e4bbd1d93/main/configuration/config.py.sample#L4-L5
* Ajouter un param√®tre ``REMOTE_MEDIAS_PATH`` et renommer le parametre ``URL_MEDIAS`` en ``REMOTE_MEDIAS_URL`` dans le fichier ``main/configuration/config.py`` : https://github.com/PnEcrins/GeoNature-atlas/blob/develop/main/configuration/config.py.sample#L124-L129

1.2.1 (2016-11-28)
------------------

**Am√©liorations**

* Prise en charge des contenus HTML dans les descriptions des articles
* Ajout du nom de la structure dans les ``<title>`` des pages
* Compl√©ments sur les templates par d√©faut ``footer.html``, ``introduction.html`` et ``pr√©sentation.html``
* Ajout de templates par d√©faut ``credits.html`` et ``mentions-legales.html`` accessibles dans une modale depuis le footer
* Am√©lioration de l'installation et s√©paration de l'installation de l'environnement (``install_env.sh``) et de l'application (``install_app.sh``)
* Am√©lioration de l'affichage des milieux dans les fiches esp√®ces
* Mise √† jour mineure de l'installation automatique de la BDD
* Mise √† jour de la documentation d'installation
* Usage des variables des types des m√©dias dans le SQL des listes de taxons
* Meilleure gestion des images par d√©faut (photo principale et logos)
* R√©vision de tous les pictos des groupes (par @DonovanMaillard)
* Simplification de la barre verticale de navigation (sidebar)
* Mise √† jour Leaflet 1.0.1 vers 1.0.2

**Corrections**

* Refonte compl√®te de l'usage de jQuery.datatables dans les listes d'esp√®ces (fiches communes, rangs taxonomiques et groupes)
* R√©paration des tooltips et autres d√©bugage dans les listes d'esp√®ces
* Correction d'un bug sur la recherche dans la galerie photos
* Correction du z-index du spinner sur les fiches esp√®ces
* Correction des caract√®res vides dans les URL et chemins des m√©dias
* Autres corrections mineures

1.2.0 (2016-11-15)
------------------

**Evolutions**

* Mise √† jour de Leaflet (version 0.7.7 √† la version 1.0.1)

**Corrections**

* Correction du bug d'affichage de la protection et patrimonialit√© sur les fiches esp√®ces. Fix #63
* Correction de l'installation automatique de la BDD (``$admin_pg`` d√©sormais cr√©√© en superuser)
* Corrections et pr√©cisions dans la documentation

1.1.3 (2016-10-12)
------------------

**Am√©liorations**

* Ajout d'un lien vers les fiches esp√®ces dans la galerie photo
* Correction de l'installation automatique de la BDD
* Complements documentation

1.1.2 (2016-10-07)
-----------------------

**Am√©liorations**

* Corrections minimes dans l'installation de la BDD
* Ajout de SHP exemples pour faciliter les tests de l'installation avec des donn√©es de tests

1.1.1 (2016-10-03)
------------------

**Am√©liorations**

* Optimisation du temps de chargement de la page d'accueil en am√©liorant la requ√™te des statistiques par rang taxonomique
* Am√©lioration de l'installation sans GeoNature en permettant d'installer le sch√©ma ``taxonomie`` de la BDD de TaxHub dans la BDD de GeoNature-atlas
* Int√©gration d'un exemple de table de donn√©es source (``synthese.syntheseff``) et de 2 observations exemple pour que l'installation automatis√©e fonctionne enti√®rement m√™me sans GeoNature
* Compl√©ments et corrections de la documentation

1.1.0 (2016-09-30)
------------------

Dernier jour de stage de Th√©o Lechemia, d√©veloppeur initial de GeoNature-atlas

**Nouveaut√©s**

* Ajout d'une liste des esp√®ces observ√©es par groupe
* Ajout des icones sur les fiches des esp√®ces qui sont patrimoniales et/ou prot√©g√©es

**Corrections**

* Correction de l'installation
* Compl√©ments dans la documentation
* Autres corrections mineures (CSS, lightbox, statistiques)


1.0.0 (2016-09-28)
------------------

Premi√®re version compl√®te et fonctionnelle de GeoNature-atlas

**Fonctionnalit√©s principales**

* Installation automatis√©e (avec GeoNature ou sans) de l'environnement, des donn√©es SIG (mailles, limite du territoire et communes) et de la BDD
* Page d'accueil dynamique et param√©trable avec introduction, statistiques globales et par rang taxonomique, carte et liste des 100 derni√®res observations et taxons les plus vues dans la p√©riode en cours (toutes ann√©es confondues)
* Recherche parmis tous les taxons observ√©s et leurs synonymes
* Fiches esp√®ces avec carte des observations (par maille ou point selon la configuration) filtrables par ann√©es, graphiques des observations par classes d'altitudes et par mois, affichage des m√©dias (photos, audios, vid√©os, liens et PDF), gestion des descriptions
* R√©cursivit√© sur les fiches esp√®ces pour agglom√©rer les observations au niveau de l'esp√®ce + des √©ventuelles niveaux inf√©rieurs (sous-esp√®ces, vari√©t√©s...)
* Gestion d'un glossaire permettant d'afficher dynamiquement la d√©finition des termes techniques
* Fiche par commune affichant la liste des esp√®ces observ√©es sur la commune, une carte des 100 derni√®res observations et la possibilit√© d'afficher la carte des observations d'une esp√®ce sur la commune
* Fiche par rang taxonomique affichant la liste des esp√®ces observ√©es dans ce rang
* Possibilit√© de configurer √† quel rang taxonomique on passe des fiches √† la liste des esp√®ces du rang
* CSS et textes enti√®rement customisables
* G√©n√©ricit√© pour se connecter √† n'importe quelle BDD comportant des observations bas√©es sur TAXREF

**A venir**

* Finition de la galerie photo (liens vers fiches esp√®ce)
* Fiche par groupe
* Gestion forcable des types d'affichage cartographique en mode point (mailles, clusters ou points √† n'importe qu'elle √©chelle)
* CSS des listes d'esp√®ces (communes et rangs taxonomiques)
